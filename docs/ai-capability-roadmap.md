# AI 能力中台 · 架构复盘与路线图（2026-01-13）

> 按“原子能力 → 工作流编排 → 知识/向量层”三层拆解。第一层打牢，才能在后续拼装业务工作流时避免返工。

---

## 1. 原子能力治理（Atomic Capabilities）

目标：确保每条能力都具备**规范的元数据、成本模型、自检机制、统一文档**，让调用体验像“用 API 市场”一样明确。

| 维度 | 当前现状 | 目标动作 |
| --- | --- | --- |
| 能力目录 | `/api/abilities` 列出 active 能力，metadata 含 `api_type/workflow_key` | ① 为每个能力补齐 `metadata.pricing`（币种、单位、对外价、折扣价）与 `SLA`（期望耗时、成功率）；② 管理端显示“成本 + 最近自检 + 成功率”（2026-01-13 已上线表格筛选 + 详情 Tab，占位卡片清晰说明自检/SLA 规划）。 |
| 成本模型 | 管理端测试面板已读取 `metadata.pricing`，并在日志中展示 | ① 在 DB 中落地 `ability_cost_snapshots`（能力/节点/调用次数/成本）；② 周、月维度输出报表；③ 接入报警：超出预算自动提醒。 |
| 自检机制 | 目前只有手动测试；`IntegrationTestService` 可复用 | ① 设计 `ability_health_checks` 表，记录计划/频率/截图；② 后台 cron 调用每个能力，日志写入 `ability_invocation_logs` 并聚合到健康面板；③ 失败自动告警并附上错误堆栈。 |
| 文档/示例 | `docs/api/abilities.md` 覆盖调用规范 | ① 为每个能力生成“卡片文档”（可由脚本遍历 metadata 输出 Markdown）；② 包含：输入参数、输出示例、成本、执行节点、最近自检时间；③ 对外开放目录供客户端选型。 |

**近期动作（按优先顺序）**
0. ✅（2026-01-13）管理端“能力目录”表格支持搜索/筛选，右侧详情抽屉拆分为“概览 / 参数 / 元信息 / 实时测试 / 调用记录”五个 Tab，并在概览卡片中预留成本、自检、SLA 占位说明。
1. 跑一遍数据库，把所有 `comfyui_*` 能力写入默认定价（0.3/张），并补充 Baidu/Volcengine/KIE 的成本。
2. 实现一个 `ability_health_runner`（FastAPI background + APScheduler 或 Celery 定时任务），每天巡检高优先级能力。
3. 在管理端的“能力管理”表格新增“成功率/最近自检时间”列，与“成本”一起呈现。

---

## 2. 工作流层（Composable Workflows）

目标：将原子能力像乐高一样拼装成业务流程，并具备**图形化编排、并发/重试策略、节点追踪、版本管理**。

| 需求 | 要点 |
| --- | --- |
| 可视化编排 | 以托管/官方 Coze Studio 为主，必要时补充 React Flow 自研组件：需要节点拖拽、输入映射、条件/并行、调试模式（逐节点执行、回放）。 |
| 数据模型 | 规范 `workflow_definition`：`nodes`（引用 `ability_id` 或 `tool`）、`links`、`settings`（timeout/retry/concurrency）、`assets`（中间态存储）。 |
| 调度执行 | TaskDispatcher 扩展为 DAG 执行器：根据节点依赖拓扑排序，支持并发执行、节点级重试/熔断；Trace ID 贯穿整条链路。 |
| 监控诊断 | 统一 `workflow_runs` 表，记录 run_id、workflow_id、版本、状态、耗时、输入摘要；`workflow_run_nodes` 记录每个节点的状态/耗时/输出 URL；管理端提供可视化 timeline。 |
| 工具库 | 将通用图像工具（PDI 增分、格式转换、裁剪/旋转等）做成轻量 Node，作为工作流节点类型之一，与 ComfyUI/Baidu/KIE 等能力混搭。 |

**下一步建议**
1. 出一份《Workflow Builder 需求》文档：列出核心能力（拖拽、版本、调试、指标），用于评估开源 vs 自研。
2. 设计工作流运行期的数据表结构与 API（`/api/workflows/:id/runs`、`/api/workflow-runs/:run_id/nodes`）。
3. 先挑选“印花提取 + OSS 入库 + PDI 增分 + STS 回传”作为试点工作流，验证 DAG 执行链路。

---

## 3. 知识/向量层与工具生态

目标：在工作流之上引入**向量检索、知识库、脚本工具**，支持更复杂的业务场景。

| 方向 | 规划 |
| --- | --- |
| 向量库原子能力 | 将 Milvus/Faiss/阿里 OpenSearch 等接口封装为 `vector_index.upsert/search/delete` 能力，具备成本/自检/日志。 |
| 数据工具 | 除图片工具外，再接入 PDF 解析、OCR、结构化清洗、PDI、鉴黄等原子能力，统一注入工作流。 |
| 合规与审计 | 记录每次能力调用的用户、成本、资产；敏感能力（OCR、向量库）需要额外审计日志。 |
| 知识工作流 | 在可视化工作流中引入“知识节点”：从向量库检索上下文、写入/更新知识，配合 LLM 提供复杂的自动化任务。 |

---

## 附：实施里程碑（Timeboxed）

| 时间 | 里程碑 |
| --- | --- |
| 2026 Q1 | 完成原子能力治理（成本、自检、日志可视化）+ 工作流需求评审 + 选型。 |
| 2026 Q2 | 落地可视化工作流 MVP（含节点调试、Trace 面板），接入首个业务工作流（印花提取流水线）。 |
| 2026 Q3 | 向量库能力接入 + 知识工作流，提供统一成本报表 & SLA dashboard，支持多项目共用中台。 |

> 后续迭代请持续在 `docs/backlog.md` 与本文档同步更新，确保“原子能力 → 工作流 → 知识层”的路线图始终清晰。
