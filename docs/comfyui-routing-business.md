# ComfyUI 路由与排队说明（业务版）

> 适用对象：业务/产品/运营同学
> 目的：解释**任务会被分配到哪台 ComfyUI 服务器**、**为什么会排队**、以及**出现慢/失败时该怎么判断**。

---

## 1. 一句话理解
- **路由**：系统会从多台 ComfyUI 服务器中，选择一台来执行任务。
- **排队**：被选中的服务器正在忙，任务要等它空出来。

---

## 2. 我们是怎么“分配服务器”的？
系统会按以下优先级选服务器：

1. **如果接口请求里指定了某台服务器**，就用它。
2. **如果能力配置里限制了允许的服务器**，就在这些里面选。
3. **如果有“工作流绑定”规则**，就用绑定到该工作流的服务器。
4. **如果以上都没有，就走默认服务器**。

> 你可以理解为：
> “**指定优先** > **能力限制** > **绑定规则** > **默认兜底**”

---

## 3. 我们支持的“分配策略”（routing_policy）
如果一个能力允许多台服务器，就会按策略选：

- **自动**（auto）：默认策略（多数情况等同固定选第一台）
- **最短队列**（queue）：优先选排队最少的机器
- **权重随机**（weight）：按权重分配（例如 70%/30%）
- **轮询**（round_robin）：轮流分配
- **固定**（fixed）：永远选第一个

> 业务上常用：
> - 追求稳定 → **固定**
> - 追求更快 → **最短队列**
> - 想平均分摊 → **轮询 / 权重**

---

## 4. 为什么会排队？
排队有两层：

### 4.1 平台内部排队（保护机器）
- 每台服务器有“最大并发数”限制
- 超过这个数量，任务会在平台内部等待

### 4.2 ComfyUI 自己的排队
- ComfyUI 本身也会排队
- 服务器正在处理的任务多，就会变慢

---

## 5. 如何查看当前排队情况？
管理端提供队列查看功能（无需自动刷新，手动刷新即可）：

- **单台队列**：查看某台服务器当前 running/pending
- **汇总队列**：查看所有 ComfyUI 服务器的总排队

> 如果业务人员只需要判断是否拥堵，看“汇总队列”就够了。

---

## 6. 任务返回会告诉你跑在哪台服务器
所有任务返回里会包含：
- `executorId`（服务器 ID）
- `baseUrl`（服务器地址）

这样业务方就能知道“任务分配到了哪台机器”。

---

## 7. 常见问题（业务角度）

### Q：任务变慢了怎么办？
先看队列：
- 若排队数多 → 正常拥堵
- 若排队不多但仍慢 → 可能机器异常

### Q：为什么没有跑到我想要的机器？
通常是：
- 没有给能力配置“允许的服务器”
- 没有绑定该工作流到指定服务器
- 开启了“回退默认节点”，系统自动兜底

---

## 8. 建议业务配置方式
对业务同学最友好的做法是：

✅ 在能力里配置：
- **允许的服务器**（allowed_executor_ids）
- **分配策略**（routing_policy）

这样该能力会只在指定服务器上跑，行为稳定。

---

如需我补充“业务流程图 / 使用截图 / 培训版本”，告诉我即可。
