# AI 图片编辑器（评测端）

> 目标：在评测端提供“标注 + 提示词重组”的可视化编辑能力，面向业务同学快速验证图片编辑效果。

## 1. 适用工作流

- workflow_id：`7604714915110060032`
- 用途：KIE Nano Banana Pro 图生图编辑（支持多参考图 + 标注意图）
- 输出：回调 task id（需通过 `/api/coze/podi/tasks/get` 查询最终图片）

## 2. 输入字段

- `url`（必填）：主图 URL
- `prompt`（必填）：提示词（支持 `@标注` 和 `#参考图`）
- `image_urls`（可选）：参考图 URL 列表，**英文逗号或换行分隔**
- `output_format`（可选）：png/jpg/webp
- `aspect_ratio`（可选）：auto/1:1/4:3/3:4/16:9/9:16
- `resolution`（可选）：1K/2K/4K

> 说明：评测端在 AI 编辑器中**默认不传** `aspect_ratio/resolution`（保持默认 auto/1K 时会被视为未填写），以便后端按原图尺寸自动匹配；如需固定画幅或分辨率，请手动选择后再提交。

## 3. 标注能力与命名

支持以下标注方式：

- 点选
- 矩形框选
- 圆形框选
- 手绘

系统会按创建顺序为每个标注自动命名：`标注1 / 标注2 / ...`，并在提示词中以 `@标注1` 的形式引用。

## 4. 参考图编号

参考图按上传顺序编号为 `#1 / #2 / #3 ...`。在提示词中使用 `#1` 即可指代对应参考图。

> 模型侧图片编号规则：**图1=主图**，**图2=参考图#1**，图3=参考图#2 …  
> 评测端会自动把 `#1/#2` 改写成 `图2/图3`，保证模型能理解对应图片。

`image_urls` 的传参规则：

```
<url1>,<url2>,<url3>
```

也支持换行写法（等价）：

```
<url1>
<url2>
<url3>
```

## 5. 提示词重组方法（核心）

评测端会将用户输入与标注信息 **自动拼接**，并附带 **系统前缀 + 图片编号映射 + 输出标准**；最终发送给 Coze 的 `prompt` 格式为：

```
【系统前缀】
你是专业的图像编辑助手。
目标：在保持主图整体风格一致的前提下，仅根据标注与参考图完成指定修改。
注意：主图=图1，参考图从图2开始编号。

【用户指令】
<用户输入的提示词>

【图像顺序规范】
图1=主图（原始上传图）
图2=参考图#1（image_urls[0]）
图3=参考图#2（image_urls[1]）
顺序固定，不得重新理解或交换

【标注说明】
@标注1（矩形）：left=120(0.12), top=80(0.08), width=240(0.24), height=60(0.06)
@标注2（点）：x=512(0.50), y=360(0.45)
@标注3（圆形）：cx=300(0.30), cy=400(0.40), r=100(0.10)
@标注4（手绘）：bbox=[10(0.01),20(0.02)]-[200(0.20),120(0.15)] points=(...)

【参考图】
图2: https://...
图3: https://...

【原图尺寸】
width=1000, height=800

【输出标准】
输出只需返回最终图片，不要输出解释性文字。
未标注区域保持不变，禁止引入无关元素。
如未明确指定画幅/分辨率，保持与主图一致。
参考图只用于风格/纹理/形象参考，不要直接拼贴。
严格遵循图像顺序规范（图1主图、图2/图3为参考图）。
```

> 说明：坐标为 **原图像素坐标**，括号内为比例（0~1）。

## 6. 示例（业务场景）

场景：上传一张圣诞主题图，框选 “Merry Christmas” 文案，并把它改成 “新年快乐”；
点选圣诞老人，并要求“参考图 #1 的人物形象”。

提示词示例（用户输入）：

```
@标注1 把这段文字改成“新年快乐”，字体风格参考 #1（模型侧=图2）
@标注2 保持圣诞老人姿势不变，但脸部参考 #1
```

## 7. 业务接入流程（开发同学）

### 7.1 Coze 工作流调用

通过 Coze `/v1/workflow/run` 调用工作流（参数与评测端一致）：

```bash
curl -X POST "$COZE_BASE_URL/v1/workflow/run" \
  -H "Authorization: Bearer $COZE_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "workflow_id": "7604714915110060032",
    "parameters": {
      "url": "https://.../main.png",
      "image_urls": "https://.../ref1.png,https://.../ref2.png",
      "prompt": "@标注1 把文字改成新年快乐；@标注2 纹理参考 #1",
      "output_format": "png"
    }
  }'
```

### 7.2 回调结果查询

该工作流返回 `output`（task id）。拿到 task id 后调用：

```bash
curl -X POST "http://<podi-host>:8099/api/coze/podi/tasks/get" \
  -H "Authorization: Bearer $SERVICE_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{ "taskId": "<output>" }'
```

返回 `imageUrl/imageUrls` 即最终结果图。

## 8. 接入建议

- 业务侧如需直接接入，请 **复制评测端的提示词拼接策略**。
- 标注必须与提示词中的 `@标注X` 保持一致。
- 参考图若为空，则不传 `image_urls`。
- 若不希望改变画幅/分辨率，请保持 `aspect_ratio/resolution` 为空（跟随原图）。

## 9. 常见问题

- **提示词为空时报错 `PROMPT_REQUIRED`**：`prompt` 为必填字段。
- **成功但无图**：先检查 `/api/coze/podi/tasks/get` 是否返回 `imageUrls`。

---

如需修改重组策略或字段格式，请同步更新本文档。
