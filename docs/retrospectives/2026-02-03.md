# 复盘纪要（2026-02-03）

> 目标：把近期变更中暴露的问题、根因与改进动作记录下来，形成可执行的“准则 + 检查清单”，避免重复踩坑。

## 一、背景与范围
- 覆盖：能力评测、管理端、Coze 工具箱与 ComfyUI 相关能力。
- 关注点：参数一致性、回调链路、OSS 介质链路、队列与超时体验。

## 二、事实回顾（What happened）
- 多次出现“工作流入参/出参与文档不一致”的情况，导致 Coze 报错或业务方误用。
- ComfyUI 链路在部分环境出现回调 `TASK_NOT_FOUND`，可用性和可排查性不足。
- OSS 环境变量更新后，出现“上传成功但无法读取/展示”之类的断链问题。
- 部分能力同步返回/轮询返回过慢，用户感知为“页面转圈/无提示”。
- 文档结构分散，缺少统一的“参数/回调/错误码/队列规范”入口。

## 三、主要问题 & 根因分析
### 1) 参数命名不一致（`url`/`Url`）
- 现象：Coze 侧要求 `url`，评测/文档出现 `Url`，导致缺参。
- 根因：工作流侧参数改动未同步到评测/文档；缺少“参数变更一键同步”机制。

### 2) 回调 `TASK_NOT_FOUND`
- 现象：回调工作流通过 `/api/coze/podi/tasks/get` 查询不到任务。
- 可能原因：
  - Coze 调用的后端环境与任务入库环境不一致（不同数据库/不同后端）。
  - 任务落库失败或被清理（缺少明确日志指引）。

### 3) OSS 链路断裂
- 现象：上传后展示失败、外链不可用。
- 根因：AK/SK 变更后部分服务未读取到新环境变量，或未统一依赖配置。

### 4) 体验问题（转圈/无提示）
- 现象：网络抖动或上游慢时，前端无明确超时提示。
- 根因：缺少“前端统一超时 + 明确错误提示”的收敛机制。

## 四、已经确认的改进动作
- **参数一致性**：以 `url` 作为统一图片入参（ComfyUI/扩图/商模）。
- **回调链路**：回调工作流 `comfyui_huidiao` 纳入“通用类”并写入文档。
- **队列与错误**：队列上限与错误码纳入标准，便于排查与对外说明。
- **测试计划**：新增 Coze workflow 冒烟测试与报告输出（详见测试文档）。

## 五、准则提炼（必须遵守）
1) **参数变更必同步**：工作流入参/出参 → 评测页面 → Coze 工具箱 → 文档（四处一致）。
2) **回调必可查**：所有异步能力必须返回可用 `taskId`，并能通过统一接口查询。
3) **OSS 统一入口**：上传/落盘/回显使用统一服务，变更 AK/SK 必验证读写。
4) **上线前必测试**：至少覆盖“提交成功、回调成功、结果正确”三项。
5) **不搞大重构**：优先补齐配置、文档、测试、提示，不做整体替换式改造。

## 六、行动项（可执行）
- [ ] 统一更新工作流文档：参数名、枚举值、回调说明（含 `taskId` 查询）。
- [ ] 在评测平台展示参数枚举与类型约束（避免业务误填）。
- [ ] 增加“回调工作流使用说明”到文档与评测页。
- [ ] 建立 OSS 变更 checklist（含读写验证、展示验证）。
- [ ] 每次上线输出一份“测试记录报告”（包含输入/输出/回调）。

## 七、风险与观察点
- Coze 工具箱/工作流更新存在延迟，需确认“是否已重新发布”。
- 上游模型（KIE/Volcengine/ComfyUI）存在不稳定，需保留 fallback/重试策略。
- 业务在使用旧工作流时必须明确“已废弃/不可用”状态提示。

## 八、补充文档清单（本次要补）
- 工作流参数与回调总表（按分类）
- 错误码与排查指引（含队列满、任务不存在等）
- OSS 变更与验证 Checklist
- 上线前测试 Checklist

