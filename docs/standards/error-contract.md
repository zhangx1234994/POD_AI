# 错误契约（Error Contract）规范

> 目的：把“错误枚举 + 文档 + 测试”固化为硬性流程，避免接口上线后错误不可追踪、不可复用。

---

## 1. 适用范围

- 后端所有新/改接口（含 public/admin/coze 插件/评测/能力调用等）
- 任何会向外部输出 `error_message` / `detail` / `taskId` 的链路

---

## 2. 错误格式与分类

### 2.1 强约束错误（格式固定）

```
ERR|<CODE>|<message>
```

用于队列/并发等**强约束**错误，必须在回调 `taskId` 或主要输出字段中可被识别。

### 2.2 关键字错误（错误关键字）

使用大写关键字（如 `TASK_NOT_FOUND` / `COZE_SUBMIT_FAILED` / `COMFYUI_SUBMIT_ERROR`），出现在：
- HTTP `detail`
- `error_message`
- `debugResponse`

---

## 3. 强制要求（不可跳过）

1) **错误枚举必须完整**
   - 新接口必须列出可能错误（最少包含：参数校验、依赖/上游失败、超时/并发）

2) **文档必须补齐**
   - 每个接口文档必须包含：请求、响应、错误
   - 评测端文档必须包含：**错误码总表 + 单功能错误列表**

3) **错误码必须进入全局错误码表**
   - 统一维护于 `docs/standards/error-catalog.md`
   - 新增/变更错误码必须同步更新

4) **测试必须覆盖关键错误路径**
   - 至少覆盖：缺参、依赖失败、队列/并发限制、超时

5) **PR 必须通过“错误契约检查”**
   - checklist：错误枚举、文档、错误码表、测试覆盖

---

## 4. 标准落地清单

- `docs/standards/error-catalog.md`：全量错误码表
- `docs/standards/queue-and-error-standards.md`：队列/并发专项规则
- `AGENTS.md`：写明“必须补错误码与文档”的硬性准则

---

## 5. 责任与验收

- **开发**：补齐错误枚举 + 文档 + 测试
- **评审**：未通过错误契约检查不得合并
- **上线**：线上文档必须可见最新错误表

---

## 6. 最低合格示例（PR 必须包含）

```
✅ 新增接口 /api/xxx
✅ 文档包含请求/响应/错误
✅ error-catalog 增加 3 个错误码
✅ pytest 覆盖缺参/超时/上游失败
```
