# Workflow 平台需求总结

## 1. 组件 / 节点
- 将现有能力（ComfyUI 印花提取、花纹扩图、四方连续、KIE、火山/百度 API 等）抽象成原子节点。
- 补充工具节点：HTTP 请求、条件判断、延时/定时、循环、OSS 上传/下载、文本处理、图片评估、LoRA 训练等。
- 节点定义包括：唯一 ID、输入/输出 schema、默认参数、执行器适配器、资源标签（GPU/CPU/外部服务）、监控指标。
- 支持节点模板（Preset），可复用常用配置；支持版本化，便于回滚。

## 2. 工作流 DSL 与配置
- 采用 JSON/DAG 结构描述：`nodes` + `links` + 全局 metadata，与 ComfyUI/Coze Studio 类似。
- 每个工作流记录版本号、创建者、更新时间、依赖能力/执行器映射、超时策略。
- 允许参数化：输入 payload 可以覆盖指定节点的字段（类似 ability current payload 覆盖）。
- 工作流与能力数据保持可追溯，支持导入/导出。

## 3. 日志与可观测性
- **节点级日志**：记录开始/结束时间、输入参数快照（敏感字段脱敏）、输出/错误堆栈、重试次数、执行节点（GPU/服务）等。
- **工作流级日志**：包含 workflow_id、运行 ID、状态（running/queued/completed/failed/timeout）、耗时、触发方、上下游任务 ID。
- 支持实时流式日志（WebSocket）和历史查询；可在管理端按节点/运行 ID 筛选。
- 结果存档：输出图像/文件统一写 OSS，并在日志里留存引用地址。

## 4. 并发与资源调度
- 工作流调度器与节点执行器解耦：调度器只负责 DAG 顺序和依赖，具体执行由各 adapter（ComfyUI、HTTP、KIE 等）完成。
- 节点需声明 `concurrency_policy`（如 queue/block/drop）、`max_parallelism`、超时策略、重试策略。
- 当节点执行器返回“排队/等待”状态（如 ComfyUI 队列），工作流实例应该进入 `waiting` 状态并异步挂起，由队列事件/轮询唤醒，避免在内存中无限等待。
- 调度器要支持持久化运行状态（DB/Redis），即使流程等待数小时也不会占用服务内存；可借鉴 Job + Heartbeat + Resume 机制。

## 5. 扩展与安全
- 所有节点、工作流、执行日志均保存在自有数据库/OSS，确保图像/模型等敏感数据可控。
- 支持权限控制：按项目/组织限制节点、工作流可见性；提供审计日志记录谁触发了什么流程。
- 可插拔执行器接口：未来支持图片评估、LoRA 训练等新任务时，只需实现新的 adapter。
- 预留对外 API：`POST /api/workflows/{id}/invoke`，可指定同步/异步、回调地址、优先级等。

## 6. 后续规划
1. 输出《节点规范 & 调度架构》详细设计，覆盖数据模型、状态机、超时/回调机制。
2. 实现最小可运行版本：纯 JSON workflow + DAG 执行 + 日志记录 + OSS 落地。
3. 在管理端新增“工作流”模块：列表/详情/运行历史/实时日志。
4. 迭代前端拖拽式编辑器（可采用 React Flow/Coze Canvas），提升可视化编排体验。
5. 持续扩充节点库（HTTP 工具、图片评估、模型训练等），并接入监控/告警。
