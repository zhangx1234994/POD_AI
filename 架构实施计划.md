# PODI 架构实施计划

## 1. 目标与范围
- 统一站内登录与第三方跳转（SSO）用户的身份、会话与权限判定。
- 构建可靠的图片处理链路：上传、排队、第三方 API + ComfyUI 执行、结果入库与下载。
- 实现积分经济闭环（冻结、扣减、对账），并与任务事件保持原子一致。
- 完善可观测性、安全策略与联调机制，为前后端分离开发提供文档化索引。

## 2. 架构细化概览
| 平面 | 组件 | 说明 | 关键对接 | 依赖文档 |
|------|------|------|----------|----------|
| 边缘接入 | API Gateway | 鉴权、限流、Trace 注入、频道判定 | 前端 `AuthProvider`、SSO 回调 | `docs/api.md`、《后端架构与业务模型》§4 |
| 身份层 | Auth Service、SSO Adapter、Session Service | 支持本地账号 + OAuth/OIDC；Session 存储 `IdentitySource` | `src/pages/Login`、`src/pages/SSO` | `docs/COMPONENT_INTERACTIONS.md` |
| 任务层 | Task Orchestrator、Job Scheduler | 参数校验、积分冻结、拆分多 Job、并发控制 | Processor 页面、`docs/task-submission-flow.md` | 《后端架构与业务模型》§5-6 |
| 媒体层 | Media Service、OSS | STS、上传回调、下载签名、版本控制 | `EnhancedImageUpload`、`GalleryManager` | 《后端架构与业务模型》§5、`docs/BUSINESS_MODEL.md` §4 |
| 钱包层 | Wallet Service | 冻结/扣减/释放、流水、套餐、对账 | `PointsProvider`、`PointsHistoryPage` | `src/services/pointsAPI.ts`、《后端架构与业务模型》§6 |
| 通知层 | Notification Hub | WebSocket/SSE/Webhook 推送，事件重放 | `docs/async-task-monitoring.md` | 《后端架构与业务模型》§8 |
| 观测层 | Logging、Metrics、Tracing | Prometheus/Grafana、Tempo | 联调工具、异常演练 | 《后端架构与业务模型》§7 |

## 3. 数据与接口需补充项
1. **Media Service API**：STS 申请、OSS 回调 payload、回调签名算法、下载签名接口、图片元数据结构。
2. **Wallet Service API**：`freeze/confirm/release` 请求体、套餐/积分规则、流水查询与导出、错误码（余额不足/预扣失败等）。
3. **Task/Event 模型**：`task_header`, `job`, `job_event`, `task_event` 的字段定义（状态机、渠道、积分引用）、事件 Topic（Kafka/RabbitMQ）。
4. **Notification 协议**：WebSocket/SSE 路径、推送消息格式、重放/断线恢复策略。
5. **SSO 渠道配置**：合作方列表、state/token 验签机制、身份映射与权限降级策略。

## 4. 任务拆分（ToDo）
### 阶段A：基础合同与模型
1. **A1 - Media Service 合同**：输出 REST + 回调文档；定义 STS/回调参数、ACL 策略；负责人：后端（存储组）。
2. **A2 - Wallet Service 合同**：补充冻结/扣减 API、积分策略配置表；负责人：后端（计费组）；协作者：前端积分模块。
3. **A3 - Task/Job 数据模型**：设计表结构、状态枚举、事件 Topic；负责人：后端（任务组）。
4. **A4 - Notification 协议**：定义 WebSocket/SSE/Webhook 结构、鉴权、重放；负责人：后端（任务组）与前端（仪表板）。
5. **A5 - SSO 渠道策略**：列出伙伴渠道、验证参数、积分政策；负责人：后端（身份组）+ 产品。

### 阶段B：PoC 与联调环境
6. **B1 - Gateway & Auth PoC**：实现基础鉴权、Trace 注入、渠道限流；输出调试环境地址。
7. **B2 - Task & Wallet 集成 PoC**：完成积分冻结→任务入队→执行→积分确认/释放 的闭环；Mock 外部 API/ComfyUI。
8. **B3 - Media 上传链路 PoC**：上线 STS 接口、OSS 回调、缩略图生成；前端完成直传与下载联调。
9. **B4 - Notification 推送 PoC**：搭建 WebSocket/SSE 服务，前端订阅任务/积分状态；验证断线重连。

### 阶段C：高可用与安全
10. **C1 - API Key 轮换机制**：定义 KMS 流程、Worker 获取短期密钥、无感知替换策略。
11. **C2 - 限流/熔断策略实现**：Gateway（IP/用户/渠道）、Scheduler（action、API key、ComfyUI token）配置及演练脚本。
12. **C3 - 日志与监控**：统一 TraceId、Prometheus 指标、告警阈值；输出仪表盘模板。
13. **C4 - 异常演练手册**：编写“积分不足”“OSS 故障”“API 限流”等演练步骤及前端期待行为。

## 5. 里程碑建议
| 里程碑 | 目标 | 交付物 |
|--------|------|--------|
| M1（本周） | 完成阶段A全部任务 | 文档：Media/Wallet/Task/Notification/SSO 合同，数据库草图 |
| M2（+2周） | 完成 PoC（阶段B）并通过前端联调 | 可访问的 Sandbox API、Mock 数据、联调笔记 |
| M3（+4周） | 完成阶段C 并进入功能迭代 | 监控仪表盘、异常演练记录、限流配置 |

## 6. 协作约定
- 文档更新优先提交至 `/Volumes/MAC 1/pod_codex` 根目录，并在 PR/评审中引用具体章节。
- 接口变更需在 Media/Wallet/Task/Notification 合同中提前 1 个版本声明，前端通过 `services/` 目录进行版本适配。
- 所有讨论结论需在 `docs/` 目录建立对应的子文档或附录，确保后续任务可追溯。
